# ğŸ” Elasticsearchå…¨æ–‡æœç´¢é›†æˆ

**æœ€åæ›´æ–°**: 2026å¹´1æœˆ1æ—¥ | **ç‰ˆæœ¬**: v2.0 | **æ€§èƒ½æå‡**: 90%

---

## ğŸ“– ç›®å½•

1. [æœç´¢åŠŸèƒ½æ¦‚è§ˆ](#æœç´¢åŠŸèƒ½æ¦‚è§ˆ)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [ç´¢å¼•ç®¡ç†](#ç´¢å¼•ç®¡ç†)
4. [æ•°æ®åŒæ­¥](#æ•°æ®åŒæ­¥)
5. [æœç´¢API](#æœç´¢api)
6. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
7. [æ•…éšœæ¢å¤](#æ•…éšœæ¢å¤)

---

## ğŸ¯ æœç´¢åŠŸèƒ½æ¦‚è§ˆ

### æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | å“åº”æ—¶é—´ | ååé‡ | ç”¨é€” |
|------|---------|--------|------|
| æ•°æ®åº“LIKE | 150-500ms | 100 QPS | å°æ•°æ®é›† |
| Redis | 30-50ms | 10K QPS | çƒ­ç‚¹æ•°æ® |
| **Elasticsearch** | **10-20ms** | **50K+ QPS** | **âœ…æ¨è** |

### æœç´¢èƒ½åŠ›

```
âœ“ å…¨æ–‡æœç´¢ - è‡ªç„¶è¯­è¨€å¤„ç†
âœ“ çŸ­è¯­æœç´¢ - ç²¾ç¡®çŸ­è¯­åŒ¹é…  
âœ“ å¸ƒå°”æœç´¢ - AND/OR/NOTç»„åˆ
âœ“ èŒƒå›´æŸ¥è¯¢ - æ—¥æœŸã€æ•°å­—èŒƒå›´
âœ“ èšåˆåˆ†æ - åˆ†ç±»ç»Ÿè®¡ã€çƒ­è¯æå–
âœ“ è‡ªåŠ¨å®Œæˆ - æœç´¢å»ºè®®
âœ“ æ‹¼å†™çº æ­£ - æ¨¡ç³ŠåŒ¹é…
âœ“ å¤šè¯­è¨€æ”¯æŒ - ä¸­æ–‡åˆ†è¯
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æœç´¢æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æœç´¢è¯·æ±‚ (ç”¨æˆ·)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœç´¢æ§åˆ¶å™¨ (SearchController)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœç´¢æœåŠ¡ (SearchService)        â”‚
â”‚  1. æŸ¥ç¼“å­˜                       â”‚
â”‚  2. æŸ¥Elasticsearch             â”‚
â”‚  3. ç»“æœä¸°å¯ŒåŒ–                   â”‚
â”‚  4. ç¼“å­˜ç»“æœ                     â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚               â”‚        â”‚
â”Œâ”€â”€vâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€vâ”€â”  â”Œâ”€â”€vâ”€â”€â”€â”€â”€â”
â”‚  Redis  â”‚ â”‚   ES   â”‚  â”‚ MySQL  â”‚
â”‚  ç¼“å­˜   â”‚ â”‚æœç´¢    â”‚  â”‚  é™çº§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®åŒæ­¥æµç¨‹

```
MySQL (æ•°æ®æº)
    â”‚
    â”œâ”€ æ’å…¥/æ›´æ–° â†’ åŒæ­¥åˆ°ES
    â”‚            â†“
    â”‚       Elasticsearch (ç´¢å¼•åº“)
    â”‚            â†“
    â”‚       æœç´¢æŸ¥è¯¢ (10-20ms)
    â”‚
    â””â”€ å®šæœŸå¢é‡åŒæ­¥ (æ¯å°æ—¶)
    â””â”€ å®šæœŸå…¨é‡åŒæ­¥ (æ¯å¤©)
```

---

## ğŸ“‘ ç´¢å¼•ç®¡ç†

### ç´¢å¼•é…ç½®

```go
// è¯é¢˜ç´¢å¼•æ˜ å°„
{
  "settings": {
    "number_of_shards": 5,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "chinese_analyzer": {
          "type": "ik_max_word"
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id": { "type": "keyword" },
      "title": {
        "type": "text",
        "analyzer": "chinese_analyzer",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "body": {
        "type": "text",
        "analyzer": "chinese_analyzer"
      },
      "user_id": { "type": "keyword" },
      "category_id": { "type": "keyword" },
      "view_count": { "type": "integer" },
      "like_count": { "type": "integer" },
      "comment_count": { "type": "integer" },
      "created_at": { "type": "date" },
      "status": { "type": "keyword" }
    }
  }
}
```

### ç´¢å¼•æ“ä½œå‘½ä»¤

```bash
# 1. åˆå§‹åŒ–ç´¢å¼•
go run main.go elasticsearch init

# 2. å…¨é‡åŒæ­¥MySQLæ•°æ®åˆ°ES
go run main.go elasticsearch sync

# 3. å¢é‡åŒæ­¥ï¼ˆä»…åŒæ­¥æœ€è¿‘å˜æ›´ï¼‰
go run main.go elasticsearch sync-incremental

# 4. æŸ¥çœ‹åŒæ­¥çŠ¶æ€
go run main.go elasticsearch sync-status

# 5. é‡å»ºç´¢å¼•ï¼ˆå®Œå…¨é‡æ–°ç´¢å¼•ï¼‰
go run main.go elasticsearch reindex
```

---

## ğŸ”„ æ•°æ®åŒæ­¥

### åŒæ­¥æ–¹å¼

#### 1. å®æ—¶åŒæ­¥ï¼ˆåˆ›å»º/æ›´æ–°æ—¶ï¼‰

```go
// åˆ›å»ºè¯é¢˜æ—¶åŒæ­¥
func (s *TopicService) Create(ctx context.Context, topic *Topic) error {
    // 1. ä¿å­˜åˆ°æ•°æ®åº“
    if err := s.repo.Create(ctx, topic); err != nil {
        return err
    }
    
    // 2. ç«‹å³ç´¢å¼•åˆ°ES
    s.elasticsearchService.IndexTopic(ctx, topic)
    
    return nil
}
```

#### 2. æ‰¹é‡åŒæ­¥ï¼ˆåˆå§‹åŒ–å’Œå‘¨æœŸæ€§ï¼‰

```bash
# é¦–æ¬¡å¯åŠ¨æ—¶åŒæ­¥æ‰€æœ‰æ•°æ®
go run main.go elasticsearch sync

# æ‰¹é‡å¤§å°: 1000æ¡/æ‰¹
# è¿™ä¼š:
# 1. æŸ¥è¯¢æ‰€æœ‰è¯é¢˜
# 2. åˆ†æ‰¹ç´¢å¼•åˆ°ES (1000æ¡ä¸ºä¸€æ‰¹)
# 3. æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
```

#### 3. å¢é‡åŒæ­¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

```bash
# æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ŒåŒæ­¥æœ€è¿‘çš„å˜æ›´
go run main.go elasticsearch sync-incremental

# è¿™ä¼š:
# 1. æŸ¥è¯¢æœ€è¿‘1å°æ—¶çš„æ–°è¯é¢˜
# 2. æŸ¥è¯¢æœ€è¿‘1å°æ—¶çš„æ›´æ–°è¯é¢˜
# 3. åˆ é™¤å·²åˆ é™¤çš„è¯é¢˜ç´¢å¼•
```

---

## ğŸ” æœç´¢API

### APIç«¯ç‚¹

```http
# 1. æœç´¢è¯é¢˜
GET /api/search/topics?q=golang&page=1&limit=20

# 2. æœç´¢å»ºè®®
GET /api/search/suggestions?q=gol&limit=10

# 3. çƒ­ç‚¹è¯é¢˜
GET /api/search/hot-topics?limit=10&period=week
```

### æœç´¢ç¤ºä¾‹

```bash
# åŸºç¡€æœç´¢
curl "http://localhost:8080/api/search/topics?q=golang"

# å¸¦åˆ†é¡µ
curl "http://localhost:8080/api/search/topics?q=golang&page=2&limit=20"

# åˆ†ç±»è¿‡æ»¤
curl "http://localhost:8080/api/search/topics?q=golang&category_id=1"

# æ’åº
curl "http://localhost:8080/api/search/topics?q=golang&sort=-view_count"
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥

```
æœç´¢ç»“æœç¼“å­˜ (24å°æ—¶):
- ç¼“å­˜é”®: search:topics:{query_hash}
- TTL: 24å°æ—¶
- è‡ªåŠ¨æ›´æ–°: ç”¨æˆ·ä¿®æ”¹æ•°æ®æ—¶æ¸…é™¤

çƒ­ç‚¹è¯é¢˜ç¼“å­˜ (1å°æ—¶):
- ç¼“å­˜é”®: hot:topics:{period}
- TTL: 1å°æ—¶
- å®šæ—¶æ›´æ–°: æ¯å°æ—¶é‡æ–°è®¡ç®—
```

### æŸ¥è¯¢ä¼˜åŒ–

```go
// ä½¿ç”¨è¿‡æ»¤å™¨å‡å°‘ç»“æœé›†
POST /api/search/topics
{
  "q": "golang",
  "filters": {
    "status": "active",
    "created_at": "2024-01-01 TO 2024-12-31"
  }
}

// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
?page=1&limit=20  // âœ“ æ¨è
?from=0&size=20   // âœ— é¿å…å¤§offset

// æ’åºä¼˜åŒ–
sort=-_score      // ç›¸å…³æ€§æ’åº
sort=-created_at  // æ—¶é—´æ’åº
sort=-view_count  // çƒ­åº¦æ’åº
```

---

## ğŸ”§ æ•…éšœæ¢å¤

### ESä¸å¯ç”¨æ—¶çš„é™çº§ç­–ç•¥

```go
// è‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
func (s *SearchService) Search(ctx context.Context, q string) ([]Topic, error) {
    // 1. å°è¯•ESæœç´¢
    results, err := s.elasticsearchService.Search(ctx, q)
    if err == nil {
        return results, nil
    }
    
    logger.Warnf("Elasticsearch unavailable, falling back to database: %v", err)
    
    // 2. é™çº§åˆ°æ•°æ®åº“LIKEæŸ¥è¯¢
    return s.topicRepository.SearchByTitle(ctx, q)
}
```

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥ESå¥åº·çŠ¶æ€
curl -s http://localhost:9200/_cluster/health | jq '.'

# æŸ¥çœ‹ç´¢å¼•çŠ¶æ€
curl -s http://localhost:9200/_cat/indices

# æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
curl -s http://localhost:9200/_nodes
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

```
å…³é”®æŒ‡æ ‡:
- æœç´¢å“åº”æ—¶é—´ (P50, P95, P99)
- æœç´¢QPS
- ç´¢å¼•å¤§å°
- åŒæ­¥å»¶è¿Ÿ
- ç¼“å­˜å‘½ä¸­ç‡
- é™çº§é¢‘ç‡
```

---
