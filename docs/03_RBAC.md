# ğŸ” æƒé™ç®¡ç†ç³»ç»Ÿ (RBAC)

**æœ€åæ›´æ–°**: 2026å¹´1æœˆ1æ—¥ | **ç‰ˆæœ¬**: v2.0

---

## ğŸ“– ç›®å½•

1. [RBACæ¦‚å¿µ](#rbacæ¦‚å¿µ)
2. [æƒé™è®¾è®¡](#æƒé™è®¾è®¡)
3. [è§’è‰²å®šä¹‰](#è§’è‰²å®šä¹‰)
4. [æƒé™æ£€æŸ¥](#æƒé™æ£€æŸ¥)
5. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ¯ RBACæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯RBAC?

**Role-Based Access Control** (åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶)

```
User â”€â”€belongs toâ”€â”€> Role â”€â”€hasâ”€â”€> Permission

ä¾‹å¦‚:
å¼ ä¸‰ (User) â”€â”€belongs toâ”€â”€> ç‰ˆä¸» (Role) â”€â”€hasâ”€â”€> åˆ é™¤è¯„è®º (Permission)
```

### æƒé™æ¨¡å‹å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          User (ç”¨æˆ·)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, name, email, ...                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ ä¸€å¯¹å¤š
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      UserRole (ç”¨æˆ·-è§’è‰²å…³è”)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user_id, role_id, assigned_at       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ å¤šå¯¹ä¸€
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Role (è§’è‰²)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, name, description, ...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ ä¸€å¯¹å¤š
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    RolePermission (è§’è‰²-æƒé™å…³è”)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ role_id, permission_id, granted_at  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ å¤šå¯¹ä¸€
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Permission (æƒé™)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id, name, description, ...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ æƒé™è®¾è®¡

### æƒé™å‘½åè§„èŒƒ

```
resource.action

ç¤ºä¾‹:
- topics.create       åˆ›å»ºè¯é¢˜
- topics.read         æŸ¥çœ‹è¯é¢˜
- topics.update       ç¼–è¾‘è¯é¢˜
- topics.delete       åˆ é™¤è¯é¢˜
- comments.create     å‘è¡¨è¯„è®º
- comments.delete     åˆ é™¤è¯„è®º
- admin.users         ç®¡ç†ç”¨æˆ·
- admin.roles         ç®¡ç†è§’è‰²
```

### å®Œæ•´æƒé™åˆ—è¡¨

| æƒé™ | æè¿° | èŒƒå›´ |
|------|------|------|
| **topics.create** | åˆ›å»ºæ–°è¯é¢˜ | è®¤è¯ç”¨æˆ· |
| **topics.read** | æŸ¥çœ‹è¯é¢˜ | å…¬å¼€ |
| **topics.update** | ç¼–è¾‘è¯é¢˜ | ä½œè€…æˆ–ç®¡ç†å‘˜ |
| **topics.delete** | åˆ é™¤è¯é¢˜ | ä½œè€…æˆ–ç®¡ç†å‘˜ |
| **comments.create** | å‘è¡¨è¯„è®º | è®¤è¯ç”¨æˆ· |
| **comments.update** | ç¼–è¾‘è¯„è®º | ä½œè€…æˆ–ç®¡ç†å‘˜ |
| **comments.delete** | åˆ é™¤è¯„è®º | ä½œè€…æˆ–ç®¡ç†å‘˜ |
| **admin.users** | ç®¡ç†ç”¨æˆ· | ç®¡ç†å‘˜ |
| **admin.topics** | ç®¡ç†è¯é¢˜ | ç®¡ç†å‘˜ |
| **admin.comments** | ç®¡ç†è¯„è®º | ç®¡ç†å‘˜ |
| **admin.roles** | ç®¡ç†è§’è‰² | è¶…çº§ç®¡ç†å‘˜ |
| **admin.permissions** | ç®¡ç†æƒé™ | è¶…çº§ç®¡ç†å‘˜ |

---

## ğŸ‘¤ è§’è‰²å®šä¹‰

### é¢„è®¾è§’è‰²

| è§’è‰² | æƒé™ | è¯´æ˜ |
|------|------|------|
| **Guest** | å…¬å¼€æƒé™ | æ¸¸å®¢ï¼ˆæœªç™»å½•ï¼‰ |
| **User** | topics.create<br>comments.create<br>ç­‰åŸºç¡€æƒé™ | æ™®é€šç”¨æˆ· |
| **Moderator** | topics.delete<br>comments.delete<br>ç”¨æˆ·ç®¡ç†æƒé™ | ç‰ˆä¸» |
| **Admin** | é™¤æƒé™ç®¡ç†å¤–æ‰€æœ‰æƒé™ | ç®¡ç†å‘˜ |
| **SuperAdmin** | å…¨éƒ¨æƒé™ | è¶…çº§ç®¡ç†å‘˜ |

### è§’è‰²æƒé™çŸ©é˜µ

```
                åˆ›å»º æŸ¥çœ‹ ç¼–è¾‘ åˆ é™¤ ç®¡ç†
          è¯é¢˜   âœ“   âœ“   âš    âš    âœ—
User      è¯„è®º   âœ“   âœ“   âš    âš    âœ—
          è®¾ç½®   âœ“   âœ“   âœ“   âœ—   âœ—

          è¯é¢˜   âœ“   âœ“   âœ“   âœ“   âœ“
Moderator è¯„è®º   âœ“   âœ“   âœ“   âœ“   âœ“
          ç”¨æˆ·   âœ—   âœ“   âœ—   âœ—   âš 

          è¯é¢˜   âœ“   âœ“   âœ“   âœ“   âœ“
Admin     è¯„è®º   âœ“   âœ“   âœ“   âœ“   âœ“
          è§’è‰²   âœ—   âœ“   âœ—   âœ—   âœ—

Super     æ‰€æœ‰   âœ“   âœ“   âœ“   âœ“   âœ“
Admin     æƒé™   âœ“   âœ“   âœ“   âœ“   âœ“

âš  = æ¡ä»¶æƒé™ï¼ˆä»…é™è‡ªå·±ï¼‰
```

---

## ğŸ” æƒé™æ£€æŸ¥

### æ–¹æ³•1: æ³¨è§£æ£€æŸ¥

```go
// @Authorize("topics.create")
func (uc *TopicController) Create(c *gin.Context) {
    // è‡ªåŠ¨æ£€æŸ¥æƒé™
}
```

### æ–¹æ³•2: ä¸­é—´ä»¶æ£€æŸ¥

```go
func RequirePermission(permission string) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetInt64("user_id")
        
        if !permissionService.HasPermission(userID, permission) {
            response.Error(c, "æƒé™ä¸è¶³")
            c.Abort()
            return
        }
        
        c.Next()
    }
}

// è·¯ç”±ä½¿ç”¨
router.POST("/api/topics", 
    RequirePermission("topics.create"), 
    topicController.Create)
```

### æ–¹æ³•3: æœåŠ¡å±‚æ£€æŸ¥

```go
func (s *TopicService) Create(ctx context.Context, req *CreateTopicRequest) error {
    userID := ctx.Value("user_id").(int64)
    
    // æ£€æŸ¥æƒé™
    if !s.permissionService.HasPermission(userID, "topics.create") {
        return errors.New("æ— åˆ›å»ºè¯é¢˜çš„æƒé™")
    }
    
    // ä¸šåŠ¡é€»è¾‘
    return s.repo.Create(ctx, &Topic{...})
}
```

### æ–¹æ³•4: ç­–ç•¥ç±»æ£€æŸ¥

```go
type TopicPolicy struct {
    permissionService *PermissionService
}

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦èƒ½ç¼–è¾‘è¯é¢˜
func (p *TopicPolicy) CanUpdate(userID int64, topic *Topic) bool {
    // ä½œè€…å¯ä»¥ç¼–è¾‘
    if topic.UserID == userID {
        return true
    }
    
    // ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘
    return p.permissionService.HasPermission(userID, "admin.topics")
}

// æ§åˆ¶å™¨ä½¿ç”¨
if !topicPolicy.CanUpdate(userID, topic) {
    return errors.New("æ— æƒé™ç¼–è¾‘æ­¤è¯é¢˜")
}
```

---

## âœ¨ æœ€ä½³å®è·µ

### æƒé™è®¾è®¡åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**
   - åªæˆäºˆå¿…è¦çš„æƒé™
   - å®šæœŸå®¡æŸ¥å’Œæ’¤é”€è¿‡æœŸæƒé™

2. **èŒè´£åˆ†ç¦»**
   - æ•æ„Ÿæ“ä½œéœ€è¦å¤šä¸ªæƒé™
   - ä¾‹å¦‚: åˆ é™¤ç”¨æˆ·éœ€è¦ `admin.users` + `audit.sensitive`

3. **æƒé™åˆ†ç»„**
   - æŒ‰èµ„æºåˆ†ç»„æƒé™
   - æŒ‰æ“ä½œåˆ†ç»„æƒé™

4. **å®¡è®¡è·Ÿè¸ª**
   - è®°å½•æ‰€æœ‰æƒé™å˜æ›´
   - è®°å½•æ•æ„Ÿæ“ä½œ

### æƒé™æ£€æŸ¥æ¸…å•

```
åœ¨æ¯ä¸ªéœ€è¦æƒé™æ§åˆ¶çš„æ¥å£:

âœ“ åœ¨è·¯ç”±å±‚æ·»åŠ æƒé™æ£€æŸ¥ä¸­é—´ä»¶
âœ“ åœ¨æœåŠ¡å±‚é‡å¤éªŒè¯æƒé™
âœ“ è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—
âœ“ å¤„ç†æƒé™ä¸è¶³çš„é”™è¯¯
âœ“ æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯æƒé™
âœ“ æ–‡æ¡£æ ‡æ³¨æƒé™è¦æ±‚
```

### å¸¸è§é™·é˜±

```
âŒ åªåœ¨å‰ç«¯æ£€æŸ¥æƒé™
âœ“ å¿…é¡»åœ¨åç«¯éªŒè¯

âŒ ä¿¡ä»»ç”¨æˆ·æä¾›çš„role_id
âœ“ ä»Tokenæˆ–Sessionè·å–ç”¨æˆ·æƒé™

âŒ æƒé™æ£€æŸ¥ä¸ä¸€è‡´
âœ“ ä½¿ç”¨ç»Ÿä¸€çš„æƒé™æ£€æŸ¥æœºåˆ¶

âŒ éšå¼æƒé™å‡è®¾
âœ“ æ˜ç¡®æ£€æŸ¥éœ€è¦çš„æ¯ä¸ªæƒé™
```

---

**æƒé™ç³»ç»Ÿç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2026å¹´1æœˆ1æ—¥  
*ç”±GoHub Security Teamç»´æŠ¤* âœ¨
