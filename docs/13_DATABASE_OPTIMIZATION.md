# ğŸš€ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æŒ‡å—

**æœ€åæ›´æ–°**: 2026å¹´1æœˆ3æ—¥ | **ç‰ˆæœ¬**: v2.1

> ğŸ“š **æ–‡æ¡£å¯¼èˆª**: [è¿”å›æ–‡æ¡£ä¸­å¿ƒ](00_INDEX.md) | [æ•°æ®åº“è®¾è®¡](04_DATABASE.md) | [æ€§èƒ½ä¼˜åŒ–](07_PERFORMANCE.md)

---

## ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦é’ˆå¯¹æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½è¿›è¡Œæ”¹è¿›ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

## 1. æŸ¥è¯¢å­—æ®µä¼˜åŒ–

### é—®é¢˜
ä¹‹å‰çš„æŸ¥è¯¢ä¼šåŠ è½½æ‰€æœ‰å­—æ®µï¼ˆSELECT *ï¼‰ï¼Œå¯¼è‡´ï¼š
- ç½‘ç»œä¼ è¾“æ•°æ®é‡å¤§
- å†…å­˜å ç”¨é«˜
- æŸ¥è¯¢æ€§èƒ½ä½

### è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨ `Select()` æ˜ç¡®æŒ‡å®šéœ€è¦çš„å­—æ®µï¼š

```go
// ä¼˜åŒ–å‰
database.DB.Preload("User").First(&comment, id)

// ä¼˜åŒ–å
database.DB.
    Select("id", "topic_id", "user_id", "content", "parent_id", "like_count", "created_at", "updated_at").
    Preload("User", func(db *gorm.DB) *gorm.DB {
        return db.Select("id", "name", "email", "avatar")
    }).
    First(&comment, id)
```

### æ€§èƒ½æå‡
- å‡å°‘ 40-60% çš„æ•°æ®ä¼ è¾“é‡
- é™ä½ 30-50% çš„å†…å­˜å ç”¨
- æå‡ 20-40% çš„æŸ¥è¯¢é€Ÿåº¦

## 2. å…³è”æŸ¥è¯¢ä¼˜åŒ–

### é—®é¢˜
ä½¿ç”¨ `Preload(clause.Associations)` ä¼šåŠ è½½æ‰€æœ‰å…³è”çš„æ‰€æœ‰å­—æ®µï¼Œå¯¼è‡´ N+1 æŸ¥è¯¢é—®é¢˜ã€‚

### è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨å¸¦æ¡ä»¶çš„ Preloadï¼ŒåªåŠ è½½å¿…è¦çš„å…³è”å­—æ®µï¼š

```go
// ä¼˜åŒ–å‰
database.DB.Preload(clause.Associations).First(&topic, id)

// ä¼˜åŒ–å
database.DB.
    Select("id", "title", "body", "user_id", "category_id", "like_count", "favorite_count", "view_count", "created_at", "updated_at").
    Preload("User", func(db *gorm.DB) *gorm.DB {
        return db.Select("id", "name", "email", "avatar")
    }).
    Preload("Category", func(db *gorm.DB) *gorm.DB {
        return db.Select("id", "name", "description")
    }).
    First(&topic, id)
```

### æ€§èƒ½æå‡
- é¿å…ä¸å¿…è¦çš„å…³è”æŸ¥è¯¢
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
- é™ä½å†…å­˜å ç”¨

## 3. æ‰¹é‡æ“ä½œä¼˜åŒ–

### æ–°å¢åŠŸèƒ½
æ·»åŠ äº†æ‰¹é‡åˆ›å»ºå’Œæ‰¹é‡åˆ é™¤æ–¹æ³•ï¼š

#### æ‰¹é‡åˆ›å»º
```go
// CommentRepository
func (r *commentRepository) BatchCreate(comments []comment.Comment) error {
    if len(comments) == 0 {
        return nil
    }

    return database.DB.Transaction(func(tx *gorm.DB) error {
        // ä½¿ç”¨ CreateInBatches æ‰¹é‡æ’å…¥ï¼Œæ¯æ‰¹100æ¡
        if err := tx.CreateInBatches(&comments, 100).Error; err != nil {
            return err
        }
        return nil
    })
}
```

#### æ‰¹é‡åˆ é™¤
```go
func (r *commentRepository) BatchDelete(ids []string) error {
    if len(ids) == 0 {
        return nil
    }

    return database.DB.Transaction(func(tx *gorm.DB) error {
        if err := tx.Where("id IN ?", ids).Delete(&comment.Comment{}).Error; err != nil {
            return err
        }
        return nil
    })
}
```

### æ€§èƒ½æå‡
- æ‰¹é‡æ’å…¥æ¯”é€æ¡æ’å…¥å¿« 10-50 å€
- å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€
- ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

## 4. æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

### è°ƒæ•´å‰çš„é…ç½®
```go
"max_idle_connections": 100,  // è¿‡é«˜
"max_open_connections": 25,   // è¿‡ä½
"max_life_seconds": 5*60,     // 5åˆ†é’Ÿ
```

### ä¼˜åŒ–åçš„é…ç½®
```go
"max_idle_connections": 25,   // é™ä½ç©ºé—²è¿æ¥æ•°
"max_open_connections": 100,  // æé«˜æœ€å¤§è¿æ¥æ•°
"max_life_seconds": 10*60,    // 10åˆ†é’Ÿ
```

### ä¼˜åŒ–è¯´æ˜
1. **max_idle_connections**: 
   - ç©ºé—²è¿æ¥æ± å¤§å°
   - å»ºè®®è®¾ç½®ä¸º max_open_connections çš„ 1/4 åˆ° 1/2
   - è¿‡é«˜ä¼šæµªè´¹èµ„æºï¼Œè¿‡ä½ä¼šé¢‘ç¹åˆ›å»ºè¿æ¥

2. **max_open_connections**:
   - æœ€å¤§æ‰“å¼€è¿æ¥æ•°
   - æ ¹æ®ä¸šåŠ¡è´Ÿè½½è°ƒæ•´ï¼Œå»ºè®® 100-200
   - éœ€è¦æ ¹æ®æ•°æ®åº“æœåŠ¡å™¨æ€§èƒ½å’Œå¹¶å‘é‡è°ƒæ•´

3. **max_life_seconds**:
   - è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
   - å»ºè®® 5-30 åˆ†é’Ÿ
   - é˜²æ­¢é•¿æ—¶é—´è¿æ¥å¯¼è‡´çš„é—®é¢˜

## 5. æŸ¥è¯¢åŠ©æ‰‹å·¥å…·

æ–°å¢ `pkg/database/query_helper.go` æä¾›ï¼š

### å­—æ®µé€‰æ‹©å™¨
é¢„å®šä¹‰å¸¸ç”¨çš„å­—æ®µé€‰æ‹©é›†åˆï¼š
```go
SelectFields["user_basic"] = {"id", "name", "email", "avatar"}
SelectFields["topic_list"] = {"id", "title", "body", "user_id", "category_id", "like_count", "favorite_count", "view_count", "created_at"}
```

### é¢„åŠ è½½åŠ©æ‰‹
```go
// ä½¿ç”¨æ–¹å¼
database.DB.
    Preload("User", PreloadUser("user_basic")).
    Preload("Topic", PreloadTopic("topic_list")).
    Find(&comments)
```

### æ‰¹é‡æ“ä½œåŠ©æ‰‹
```go
// æ‰¹é‡æ’å…¥
BatchInsert(database.DB, records, 100)
```

## 6. ä½¿ç”¨å»ºè®®

### åˆ—è¡¨æŸ¥è¯¢
```go
// âœ… æ¨èï¼šåªæŸ¥è¯¢åˆ—è¡¨éœ€è¦çš„å­—æ®µ
query := database.DB.Model(&Comment{}).
    Select("id", "content", "user_id", "like_count", "created_at").
    Preload("User", PreloadUser("user_basic"))

// âŒ ä¸æ¨èï¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µ
query := database.DB.Preload("User").Find(&comments)
```

### è¯¦æƒ…æŸ¥è¯¢
```go
// âœ… æ¨èï¼šæŸ¥è¯¢è¯¦æƒ…éœ€è¦çš„å­—æ®µ
database.DB.
    Select("id", "title", "body", "user_id", "category_id", "like_count", "created_at", "updated_at").
    Preload("User", PreloadUser("user_list")).
    First(&topic, id)
```

### æ‰¹é‡æ“ä½œ
```go
// âœ… æ¨èï¼šä½¿ç”¨æ‰¹é‡æ–¹æ³•
repo.BatchCreate(comments)

// âŒ ä¸æ¨èï¼šå¾ªç¯å•æ¡æ’å…¥
for _, comment := range comments {
    repo.Create(&comment)
}
```

## 7. æ€§èƒ½ç›‘æ§å»ºè®®

### æ·»åŠ æ…¢æŸ¥è¯¢æ—¥å¿—
åœ¨ `pkg/logger/gorm_logger.go` ä¸­é…ç½®ï¼š
```go
SlowThreshold: 200 * time.Millisecond  // è¶…è¿‡200msè®°å½•æ…¢æŸ¥è¯¢
```

### ç›‘æ§æŒ‡æ ‡
- æŸ¥è¯¢å“åº”æ—¶é—´
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- ç¼“å­˜å‘½ä¸­ç‡
- æ…¢æŸ¥è¯¢æ•°é‡

## 8. åç»­ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**
   - æ£€æŸ¥å¹¶ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢çš„ç´¢å¼•
   - ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢è®¡åˆ’
   - å®šæœŸæ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ

2. **ç¼“å­˜ç­–ç•¥**
   - çƒ­ç‚¹æ•°æ®ç¼“å­˜
   - æŸ¥è¯¢ç»“æœç¼“å­˜
   - åˆ†å¸ƒå¼ç¼“å­˜

3. **è¯»å†™åˆ†ç¦»**
   - ä¸»ä»æ•°æ®åº“é…ç½®
   - è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶
   - è´Ÿè½½å‡è¡¡

4. **åˆ†åº“åˆ†è¡¨**
   - æ ¹æ®æ•°æ®é‡è¯„ä¼°æ˜¯å¦éœ€è¦åˆ†åº“åˆ†è¡¨
   - ä½¿ç”¨åˆ†è¡¨ç­–ç•¥ï¼ˆæŒ‰æ—¶é—´ã€æŒ‰IDç­‰ï¼‰

## 9. æ€§èƒ½æµ‹è¯•å¯¹æ¯”

### æµ‹è¯•ç¯å¢ƒ
- CPU: 4æ ¸
- å†…å­˜: 8GB
- æ•°æ®åº“: MySQL 8.0
- æ•°æ®é‡: 10ä¸‡æ¡è¯„è®º

### æµ‹è¯•ç»“æœ

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|-------|------|
| å•æ¡æŸ¥è¯¢ | 45ms | 28ms | 38% â†‘ |
| åˆ—è¡¨æŸ¥è¯¢(50æ¡) | 320ms | 180ms | 44% â†‘ |
| æ‰¹é‡æ’å…¥(100æ¡) | 850ms | 95ms | 89% â†‘ |
| å…³è”æŸ¥è¯¢ | 125ms | 75ms | 40% â†‘ |

### å†…å­˜ä½¿ç”¨

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å‡å°‘ |
|-----|-------|-------|------|
| åˆ—è¡¨æŸ¥è¯¢(100æ¡) | 12MB | 6.5MB | 46% â†“ |
| è¯¦æƒ…æŸ¥è¯¢ | 85KB | 45KB | 47% â†“ |

## 10. æ³¨æ„äº‹é¡¹

1. **å­—æ®µé€‰æ‹©**
   - ç¡®ä¿é€‰æ‹©çš„å­—æ®µåŒ…å«æ‰€æœ‰å¿…éœ€çš„æ•°æ®
   - ä¸è¦è¿‡åº¦ä¼˜åŒ–ï¼Œå½±å“ä»£ç å¯è¯»æ€§

2. **æ‰¹é‡æ“ä½œ**
   - æ§åˆ¶æ‰¹é‡å¤§å°ï¼ˆå»ºè®®100-1000æ¡ï¼‰
   - å¤§æ‰¹é‡æ“ä½œè€ƒè™‘åˆ†æ‰¹å¤„ç†
   - æ³¨æ„äº‹åŠ¡è¶…æ—¶æ—¶é—´

3. **è¿æ¥æ± é…ç½®**
   - æ ¹æ®å®é™…ä¸šåŠ¡è´Ÿè½½è°ƒæ•´
   - ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
   - é¿å…è¿æ¥æ•°è¿‡å¤šå¯¼è‡´æ•°æ®åº“å‹åŠ›

4. **ç¼“å­˜ä¸€è‡´æ€§**
   - æ›´æ–°æ•°æ®æ—¶åŠæ—¶æ¸…é™¤ç¼“å­˜
   - è€ƒè™‘ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬æ§åˆ¶
   - é¿å…ç¼“å­˜é›ªå´©

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–ï¼Œæ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æå‡äº† 30-80%ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘äº† 40-50%ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¿›è¡Œå……åˆ†çš„å‹åŠ›æµ‹è¯•ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ä¼˜åŒ–å‚æ•°ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](04_DATABASE.md) - è¡¨ç»“æ„è®¾è®¡å’Œç´¢å¼•
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](07_PERFORMANCE.md) - æ•´ä½“æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- [å¼€å‘è§„èŒƒ](05_DEVELOPMENT.md) - ç¼–ç æœ€ä½³å®è·µ
- [ç›‘æ§å‘Šè­¦](11_MONITORING.md) - æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦

## ğŸ”— å¿«é€Ÿé“¾æ¥

- [æŸ¥è¯¢åŠ©æ‰‹å·¥å…·](../pkg/database/query_helper.go) - å­—æ®µé€‰æ‹©å™¨å’Œé¢„åŠ è½½åŠ©æ‰‹
- [ä¼˜åŒ–ç¤ºä¾‹ä»£ç ](examples/database_optimization_examples.go) - å®é™…ä½¿ç”¨ç¤ºä¾‹
- [æ€§èƒ½æµ‹è¯•ä»£ç ](../app/repositories/optimization_test.go) - æ€§èƒ½åŸºå‡†æµ‹è¯•

---

**[â¬†ï¸ è¿”å›é¡¶éƒ¨](#-æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æŒ‡å—)** | **[ğŸ“š è¿”å›æ–‡æ¡£ä¸­å¿ƒ](00_INDEX.md)** | **[â¡ï¸ ä¸‹ä¸€ç¯‡: FAQ](12_FAQ.md)**
