# 📊 监控与告警系统

**最后更新**: 2026年1月1日 | **版本**: v2.0

---

## 📖 目录

1. [监控架构](#监控架构)
2. [关键指标](#关键指标)
3. [告警规则](#告警规则)
4. [仪表盘](#仪表盘)
5. [故障响应](#故障响应)

---

## 🏗️ 监控架构

```
┌─────────────────────────────────┐
│    应用实例 + Prometheus Agent   │
└────────────────┬────────────────┘
                 │ 拉取 (15s)
┌────────────────v────────────────┐
│      Prometheus Server          │
│  - 时间序列数据库               │
│  - 数据保留7天                  │
└─────────────┬──────────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
┌───v────────┐    ┌────v─────────┐
│   Alerting │    │  Grafana      │
│   Rules    │    │  仪表盘       │
└───┬────────┘    └──────────────┘
    │
┌───v────────┐
│ AlertManager│
│ 邮件/钉钉  │
└────────────┘
```

---

## 📈 关键指标

### 应用层指标

| 指标 | 告警阈值 | 说明 |
|------|---------|------|
| **请求延迟 P99** | > 1000ms | 服务响应变慢 |
| **错误率** | > 0.5% | 应用出现故障 |
| **吞吐量** | < 100 QPS | 流量异常低 |
| **登录失败率** | > 10% | 认证问题 |

### 数据库指标

| 指标 | 告警阈值 | 说明 |
|------|---------|------|
| **连接数** | > 80 | 连接池接近满 |
| **慢查询** | > 10次/min | 查询性能下降 |
| **磁盘使用率** | > 80% | 磁盘空间不足 |
| **主从延迟** | > 5s | 复制延迟过大 |

### 缓存指标

| 指标 | 告警阈值 | 说明 |
|------|---------|------|
| **命中率** | < 70% | 缓存效率低 |
| **内存使用** | > 80% | 内存接近满 |
| **连接数** | > 100 | Redis连接过多 |

### 系统资源

| 指标 | 告警阈值 | 说明 |
|------|---------|------|
| **CPU使用率** | > 80% | CPU压力大 |
| **内存使用率** | > 85% | 内存接近满 |
| **磁盘使用率** | > 85% | 磁盘空间紧张 |
| **网络I/O** | > 90% | 网络带宽接近满 |

---

## 🚨 告警规则

### Prometheus告警配置

```yaml
groups:
  - name: gohub
    rules:
      # 应用告警
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.005
        for: 5m
        annotations:
          summary: "应用错误率高"
          
      - alert: HighLatency
        expr: histogram_quantile(0.99, http_request_duration_seconds) > 1
        for: 5m
        annotations:
          summary: "请求延迟高"
          
      # 数据库告警
      - alert: HighConnectionCount
        expr: mysql_global_status_threads_connected > 80
        for: 5m
        annotations:
          summary: "MySQL连接数过多"
```

---

## 📊 仪表盘

### Grafana仪表盘

```
应用监控:
├─ 请求速率 (QPS)
├─ 响应延迟 (P50, P95, P99)
├─ 错误率
└─ 吞吐量

数据库监控:
├─ 连接数
├─ 查询耗时
├─ 慢查询数
└─ 复制延迟

缓存监控:
├─ 命中率
├─ 内存占用
└─ 操作延迟

系统监控:
├─ CPU使用率
├─ 内存使用率
├─ 磁盘使用率
└─ 网络I/O
```

---

## 🚨 故障响应

### 告警升级流程

```
告警触发
  ↓
PagerDuty通知 (邮件/手机)
  ↓
工程师响应 (30分钟内)
  ↓
  ├─ 问题确认
  ├─ 初步诊断
  └─ 激活应急预案
  ↓
恢复服务
  ├─ 临时方案
  ├─ 持久修复
  └─ 验证
  ↓
事后总结
  ├─ 根因分析
  ├─ 改进措施
  └─ 知识分享
```

---

**监控版本**: v2.0  
**可用性**: 99.9%  
**最后更新**: 2026年1月1日  
*由GoHub Operations Team维护* ✨
